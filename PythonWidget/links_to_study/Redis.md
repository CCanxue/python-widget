

### `Redis` 持久化的几种方式

#### 1、前言

`Redis`是一种高级 `key`-`value`数据库。

`Redis`跟`Memcached`类似，不过数据可以持久化，而且支持的数据类型很丰富。有`str`、`list`、`set`、`hash`、`zset(sorted set)`。支持在服务器端计算集合的并、交和补集，还支持各种排序功能。所以`Redis`也可以被看成是一个数据结构服务器。

`Redis`的所有数据都是保存在内存中，然后不定期的通过`异步`方式保存到磁盘上(这称为"半持久化模式"-`RDB`)；也可以把每一次数据变化都写入到一个`Append Only File`里面（这称为"全持久化模式"-`AOF`）。

由于`Redis`的数据都存放在内存中，如果没有配置持久化， `Redis`重启后数据就全丢失了，于是需要开启`Redis`的持久化功能，讲数据保存到磁盘上，当`Redis`重启后，可以从磁盘中恢复数据。

`Redis`提供两种方式进行持久化，一种是`RDB`持久化（原理是将`Redis`在内存中的数据库记录定时`Dump`到磁盘上的`RDB`持久化），另外一种是`AOF`（`Append Only File`)持久化（原理是将`Redis`的操作日志以追加的方式写入文件）。

那么这两种持久化有什么区别呢，该如何选择呢？

#### 2、两者的区别

`RDB`持久化是指在制定的时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是`Fork`一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。

![rdb](rdb.png)

`AOF`持久化以日志的形式记录服务器所处理的每一个写、删除操作，查询操作不会记录，以文本的方式记录，可以打开文件看到详细的操作记录。

![aof](aof.png)

#### 3、两者优缺点

##### `RDB`存在哪些优势呢？

- 一旦采用该方式，那么你的整个`Redis`数据库将只包含一个文件，这对于文件备份而言是非常完美的。比如，你可能打算每个小时归档一次最近24小时的数据，同时还要每天归档一次最近30天的数据。通过这样的备份策略，一旦系统出现灾难性故障，我们可以非常容易的进行恢复。
- 对于灾难恢复而言，`RDB`是非常不错的选择。因为我们可以轻松的将一个单独的文件压缩后再转移到其他存储介质上。
- 性能最大化。对于`Redis`的服务进程而言，在开始持久化时，它唯一需要做的就是`fork`出子进程，之后再由子进程完成这些持久化的工作，这样就可以极大地避免服务进程执行`IO`操作了。
- 相比于`AOF`机制，如果数据集很大，`RDB`的启动效率会更高。

##### `RDB`又存在哪些劣势呢？

- 如果你想保证数据的高可用性，即最大限度的避免数据丢失，那么`RDB`将不是一个很好的选择。因为系统一旦在定时持久化之前出现宕机现象，此前没有来得及写入磁盘的数据都将丢失。
- 由于`RDB`是通过`fork`子进程来协助完成数据持久化工作的，因此，如果当数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是1秒钟。



##### `AOF`的有些有哪些呢？

- 该机制可以带来更高的数据安全性，即数据持久性。`Redis`中提供了3种同步策略，即每秒同步、每修改同步和不同步。事实上，每秒同步也是异步完成的，其效率也是非常高德，所差的是一旦系统出现宕机现象，那么这一秒钟之内修改的数据将会丢失。而每次修改同步，我们可以将其视为同步持久化，即每次发生的数据变化都会被立即记录到磁盘中。可以预见，这种方式在效率上是最低的。至于无同步，无需多言，我像大家都能正确的理解它。
- 由于该机制对日志文件的写入操作采用的是`append`模式，因此在写入过程中即使出现宕机现象，也不会破坏日志文件中已经存在的内容。然而如果我们本次操作知识写入了一半数据就出现了系统奔溃问题，不用担心，在`Redis`下一次启动之前，我们可以通过`redis-check-aof`工具来帮助我们解决数据一致性的问题。
- 如果日志过大，`Redis`可以自动启用`rewrite`机制。即`Redis`以`append`模式不断的将修改数据写入到老的磁盘文件中，同时`Redis`还会创建一个新的文件用于记录此期间有哪些修改命令被执行。因此在进行`rewrite`切换时可以更好地保证数据安全性。
- `AOF`包含一个格式清晰、易于理解的日至文件用于记录所有的修改操作。事实上，我们也可以通过该文件完成数据的重建。

##### `AOF`有哪些劣势呢？

- 对于相同数量的数据集而言，`AOF`文件通常要大于`RDB`文件。`RDB`在恢复大数据集时的速度比`AOF`恢复的要快。
- 根据同步策略的不同，`AOF`在运行效率上往往会慢于`RDB`。综治，每秒同步策略的效率还是比较高的，同步禁用策略的效率和`RDB`一样高效。

*二者选择的标准，就是看系统是愿意牺牲一些性能，换取更高的缓存一性质(`AOF`)，还是愿意写操作频繁的时候，不启用备份来换取更高的性能，待手动运行`save`的时候，再做备份（`rdb`)。*

#### 4、常用配置

#### `RDB`持久化配置

`Redis`会将数据集的快照`dump`到`dump.rdb`文件中。此外，我们也可以通过配置文件来修改`Redis`服务器`dump`快照的频率，在打开`6379.conf`文件之后，我们搜索`save`，可以看到下面的配置信息：

```
save 900 1              #在900秒(15分钟)之后，如果至少有1个key发生变化，则dump内存快照。

save 300 10             #在300秒(5分钟)之后，如果至少有10个key发生变化，则dump内存快照。

save 60 10000           #在60秒(1分钟)之后，如果至少有10000个key发生变化，则dump内存快照。
```



#### `AOF`持久化配置

在`Redis`的配置文件中存在三种同步方式，它们分别是：

```
`appendfsync always`      #每次有数据修改发生时都会写入`AOF`文件。

`appendfsync everysec`    #每秒钟同步一次，该策略为`AOF`的缺省策略。

`appendfsync no `         #从不同步。高效但是数据不会被持久化。
```